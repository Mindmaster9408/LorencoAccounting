<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PAYE Reconciliation - Lorenco Paytime</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      margin-left: 0;
    }
    .wrapper { display: flex; gap: 20px; max-width: 1600px; margin: 0 auto; }

    /* SIDEBAR */
    .sidebar {
      width: 300px;
      background: white;
      border-radius: 15px;
      padding: 25px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
      flex-shrink: 0;
    }
    .sidebar-header { padding: 0 20px 20px; border-bottom: 2px solid #eee; }
    .sidebar-title { color: #667eea; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
    .current-company { background: #f0f4ff; padding: 12px 15px; border-radius: 8px; color: #333; font-size: 0.9rem; font-weight: 600; word-break: break-word; }
    .sidebar-section { margin-top: 20px; }
    .sidebar-section-title { padding: 10px 20px; color: #999; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    .sidebar-link { display: block; padding: 12px 20px; color: #666; text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; font-weight: 500; }
    .sidebar-link:hover { background: #f8f9fa; color: #667eea; border-left-color: #667eea; }
    .sidebar-link.active { background: #f0f4ff; color: #667eea; border-left-color: #667eea; font-weight: 600; }
    .sidebar-actions { padding: 15px 20px; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
    .btn-sidebar { padding: 10px 15px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; }
    .btn-switch { background: #667eea; color: white; }
    .btn-switch:hover { background: #5568d3; }
    .btn-logout { background: #eee; color: #333; }
    .btn-logout:hover { background: #ddd; }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    .header-section { margin-bottom: 20px; }
    .header-section h1 { font-size: 1.8rem; color: #667eea; margin-bottom: 10px; }
    .company-name { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #333; }
    .period-info { font-size: 12px; color: #666; margin-bottom: 15px; }

    .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
    .toolbar select, .toolbar input { padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 13px; }
    .toolbar button { padding: 8px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .toolbar button:hover { transform: translateY(-1px); }
    .toolbar button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-save { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-approve { background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; }
    .btn-lock { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .btn-config { background: #6c757d; color: white; }

    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; }
    .status-draft { background: #e8eaf6; color: #667eea; }
    .status-approved { background: #c8e6c9; color: #388e3c; }
    .status-locked { background: #ffecb3; color: #f57c00; }

    .recon-container { border-radius: 8px; overflow-x: auto; border: 1px solid #eee; }

    table { width: 100%; border-collapse: collapse; font-size: 11px; background: white; }
    th, td { border: 1px solid #ddd; padding: 5px 7px; text-align: right; white-space: nowrap; }
    th { background: #667eea; color: white; font-weight: bold; text-align: center; position: sticky; top: 0; z-index: 10; }

    .employee-header { background: #f0f4ff; color: #333; font-weight: bold; text-align: left; cursor: pointer; -webkit-user-select: none; user-select: none; border-bottom: 2px solid #667eea; }
    .employee-header:hover { background: #e8eaf6; }
    .employee-header .expand-icon { display: inline-block; width: 20px; text-align: center; font-weight: bold; margin-right: 8px; }
    .employee-data { display: none; }
    .employee-data.expanded { display: table-row; }
    .row-label { text-align: left; font-weight: 600; background: #fff; padding-left: 20px; }
    .section-label { background: #e8eaf6; font-weight: bold; text-align: left; padding-left: 10px; }

    .total-row { background: #fff3e0; font-weight: bold; }
    .netto-row { background: #e8f5e9; font-weight: bold; }
    .variance-row { background: #fce4ec; font-weight: bold; }

    td input { width: 100%; border: none; padding: 3px 5px; text-align: right; background: transparent; font-size: 11px; font-family: inherit; }
    td input:focus { outline: 2px solid #667eea; background: #f0f4ff; border-radius: 3px; }
    td.readonly, td.readonly input { background: #f5f5f5; color: #999; cursor: not-allowed; }

    .grand-total-row { background: #667eea; color: white; font-weight: bold; font-size: 12px; }

    .month-col { min-width: 70px; }
    .name-col { min-width: 200px; text-align: left; padding-left: 10px; background: #fff; position: sticky; left: 0; z-index: 5; }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { width: 250px; }
      .main-content { padding: 20px; }
    }
    @media (max-width: 768px) {
      .wrapper { flex-direction: column; }
      .sidebar { width: 100%; position: relative; top: 0; }
    }
  </style>
  <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
  <button id="mobile-hamburger" class="mobile-hamburger"><span style="font-size:20px;">&#9776;</span></button>
  <div id="mobile-overlay" class="mobile-overlay"></div>
  <div class="wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Menu</div>
        <div class="current-company" id="sidebarCompanyName">Loading...</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-section-title">Navigation</div>
        <a href="company-dashboard.html" class="sidebar-link">üìä Dashboard</a>
        <a href="employee-management.html" class="sidebar-link">üë• Employees</a>
        <a href="payruns.html" class="sidebar-link">üíµ Pay Runs</a>
        <a href="payroll-items.html" class="sidebar-link">üìã Payroll Items</a>
        <a href="attendance.html" class="sidebar-link">‚è∞ Attendance</a>
        <a href="reports.html" class="sidebar-link">üìä Reports</a>
        <a href="paye-reconciliation.html" class="sidebar-link active">üßæ PAYE Reconciliation</a>
        <a href="historical-import.html" class="sidebar-link">üì• Historical Import</a>
        <a href="company-details.html" class="sidebar-link">üè¢ Company Details</a>
      </div>
      <div class="sidebar-actions">
        <button class="btn-sidebar btn-switch" onclick="window.location.href='company-selection.html'">‚Üê Return to Dashboard</button>
        <button class="btn-sidebar btn-logout" onclick="handleLogout()">üö™ Logout</button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="header-section">
        <h1>üßæ PAYE Reconciliation</h1>
        <div class="company-name" id="companyName">Loading...</div>
        <div class="period-info">Salary Variantities: <span id="periodDates">2025-03 - 2026-02</span></div>
        <div style="margin-top: 10px;">
          Status: <span class="status-badge status-draft" id="statusBadge">DRAFT</span>
        </div>
      </div>

      <div class="header-section">
        <div class="toolbar">
          <label style="font-weight: 600; color: #333;">Period:</label>
          <select id="periodSelect" onchange="loadPeriod()">
            <option value="2025-2026">2025/2026 Tax Year</option>
          </select>
          <button class="btn-config" onclick="window.location.href='paye-config.html'">‚öô Configuration</button>
          <div style="flex: 1;"></div>
          <button id="saveBtn" class="btn-save" onclick="saveDraft()">üíæ Save Draft</button>
          <button id="approveBtn" class="btn-approve" onclick="approveRecon()">‚úì Approve</button>
          <button id="lockBtn" class="btn-lock" onclick="lockRecon()">üîí Lock</button>
        </div>
      </div>

      <div class="recon-container">
        <table id="reconTable">
          <thead id="reconHead"></thead>
          <tbody id="reconBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <nav class="mobile-bottom-nav">
    <a href="company-dashboard.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128202;</span><span class="mobile-nav-label">Dashboard</span></a>
    <a href="employee-management.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128101;</span><span class="mobile-nav-label">Employees</span></a>
    <a href="payruns.html" class="mobile-nav-item"><span class="mobile-nav-icon">&#128181;</span><span class="mobile-nav-label">Pay Runs</span></a>
    <a href="paye-reconciliation.html" class="mobile-nav-item active"><span class="mobile-nav-icon">üßæ</span><span class="mobile-nav-label">PAYE Recon</span></a>
  </nav>

  <script src="js/data-access.js"></script>
  <script src="js/permissions.js"></script>
  <script src="js/audit.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/payroll-engine.js"></script>
  <script>
    const months = ['MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC', 'JAN', 'FEB'];
    const monthKeys = ['2025-03', '2025-04', '2025-05', '2025-06', '2025-07', '2025-08', '2025-09', '2025-10', '2025-11', '2025-12', '2026-01', '2026-02'];

    let employees = [];
    let config = { incomeTypes: [], deductionTypes: [] };
    let reconData = {};
    let emp201Data = {};
    let status = 'DRAFT';
    let currentPeriodId = 1;
    let currentReconId = null;
    let currentCompanyId = null;

    function init() {
      // Check auth
      const session = AUTH.getSession();
      if (!session || !session.company_id) {
        window.location.href = 'login.html';
        return;
      }
      currentCompanyId = session.company_id;

      // Set company name
      const company = AUTH.getCompanyById(session.company_id);
      const companyName = company ? company.name : 'Company';
      document.getElementById('companyName').textContent = companyName;
      document.getElementById('sidebarCompanyName').textContent = companyName;

      loadConfig();
      loadEmployees();
      renderTable();
    }

    function loadConfig() {
      // Load config from localStorage (payroll app is localStorage-based)
      const stored = localStorage.getItem('paye_config_' + currentCompanyId);
      if (stored) {
        try {
          const data = JSON.parse(stored);
          config.incomeTypes = data.incomeTypes || [];
          config.deductionTypes = data.deductionTypes || [];
        } catch (e) {
          useDefaultConfig();
        }
      } else {
        useDefaultConfig();
      }
    }

    function useDefaultConfig() {
      config.incomeTypes = [
        { key: 'basic_salary', label: 'Basic Salary', isDefault: true },
        { key: 'overtime', label: 'Overtime', isDefault: false },
        { key: 'allowance', label: 'Allowance', isDefault: false },
        { key: 'bonus', label: 'Bonus', isDefault: false },
        { key: 'commission', label: 'Commission', isDefault: false }
      ];
      config.deductionTypes = [
        { key: 'paye', label: 'PAYE', isDefault: true },
        { key: 'uif', label: 'UIF', isDefault: true },
        { key: 'pension', label: 'Pension Fund', isDefault: false },
        { key: 'medical_aid', label: 'Medical Aid', isDefault: false },
        { key: 'garnishee', label: 'Garnishee Order', isDefault: false }
      ];
    }

    function loadEmployees() {
      // Load employees from localStorage (payroll storage key)
      const stored = localStorage.getItem('employees_' + currentCompanyId);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          employees = parsed.map((emp, idx) => ({
            id: emp.id || ('emp-' + idx),
            employeeCode: emp.employee_number || emp.employeeCode || ('EMP' + String(idx + 1).padStart(3, '0')),
            firstName: emp.first_name || emp.firstName || 'Employee',
            lastName: emp.last_name || emp.lastName || (idx + 1).toString(),
            isActive: emp.is_active !== undefined ? emp.is_active : (emp.isActive !== undefined ? emp.isActive : true)
          })).filter(e => e.isActive !== false);
        } catch (e) {
          useDemoEmployees();
        }
      } else {
        useDemoEmployees();
      }

      // Load saved recon data from localStorage
      const savedRecon = localStorage.getItem('paye_recon_data_' + currentCompanyId);
      if (savedRecon) {
        try {
          const parsed = JSON.parse(savedRecon);
          reconData = parsed.reconData || {};
          emp201Data = parsed.emp201Data || {};
          status = parsed.status || 'DRAFT';
        } catch (e) {
          initializeReconData();
        }
      } else {
        initializeReconData();
      }

      // Ensure all employees have data
      employees.forEach(emp => {
        if (!reconData[emp.id]) {
          reconData[emp.id] = {};
          monthKeys.forEach(mk => {
            reconData[emp.id][mk] = { income: {}, deductions: {}, gross: 0, totalDed: 0, netto: 0, bank: 0, diff: 0 };
          });
        }
      });

      // Ensure emp201Data has all months
      monthKeys.forEach(mk => {
        if (!emp201Data[mk]) emp201Data[mk] = { paye: 0, uif: 0, sdl: 0 };
      });

      updateStatus();
    }

    function useDemoEmployees() {
      employees = [
        { id: 1, employeeCode: 'EMP001', firstName: 'John', lastName: 'Smith', isActive: true },
        { id: 2, employeeCode: 'EMP002', firstName: 'Sarah', lastName: 'Johnson', isActive: true },
        { id: 3, employeeCode: 'EMP003', firstName: 'Michael', lastName: 'Williams', isActive: true },
        { id: 4, employeeCode: 'EMP004', firstName: 'Emma', lastName: 'Brown', isActive: true },
        { id: 5, employeeCode: 'EMP005', firstName: 'David', lastName: 'Jones', isActive: true }
      ];
      initializeReconData();
    }

    function initializeReconData() {
      reconData = {};
      emp201Data = {};

      monthKeys.forEach(mk => {
        emp201Data[mk] = { paye: 0, uif: 0, sdl: 0 };
      });

      // Try to pull data from payrun history
      const payrunData = loadPayrunHistory();

      employees.forEach(emp => {
        reconData[emp.id] = {};
        monthKeys.forEach((mk, idx) => {
          reconData[emp.id][mk] = {
            income: {},
            deductions: {},
            gross: 0,
            totalDed: 0,
            netto: 0,
            bank: 0,
            diff: 0
          };

          // If we have payrun data for this employee/month, use it
          const payrunForMonth = payrunData[emp.id] && payrunData[emp.id][mk];
          if (payrunForMonth) {
            reconData[emp.id][mk].income = payrunForMonth.income || {};
            reconData[emp.id][mk].deductions = payrunForMonth.deductions || {};
            reconData[emp.id][mk].bank = payrunForMonth.netPay || 0;
          } else {
            // Use demo data
            const baseData = [
              { basic: 25000, overtime: 1500, allowance: 2000, paye: 4250, uif: 148.50, pension: 2500, medical: 1850, garnishee: 0, bank: 19000 },
              { basic: 18000, overtime: 1200, allowance: 1500, paye: 2800, uif: 107.10, pension: 1800, medical: 1650, garnishee: 500, bank: 13500 },
              { basic: 22000, overtime: 1800, allowance: 1800, paye: 3600, uif: 130.90, pension: 2200, medical: 1750, garnishee: 0, bank: 16500 },
              { basic: 16000, overtime: 1000, allowance: 1200, paye: 2400, uif: 95.20, pension: 1600, medical: 1500, garnishee: 300, bank: 12000 },
              { basic: 30000, overtime: 2000, allowance: 2500, paye: 5200, uif: 178.50, pension: 3000, medical: 2000, garnishee: 0, bank: 22000 }
            ];

            const empIndex = employees.indexOf(emp);
            if (empIndex >= 0 && empIndex < baseData.length) {
              const data = baseData[empIndex];
              reconData[emp.id][mk].income = {
                basic_salary: data.basic + (idx * 100),
                overtime: idx % 2 === (empIndex % 2) ? data.overtime : 0,
                allowance: data.allowance,
                bonus: idx === 11 ? data.basic * 0.2 : 0,
                commission: idx % 3 === 0 ? (empIndex * 200 + 200) : 0
              };
              reconData[emp.id][mk].deductions = {
                paye: data.paye + (idx * 15),
                uif: data.uif,
                pension: data.pension,
                medical_aid: data.medical,
                garnishee: data.garnishee
              };
              reconData[emp.id][mk].bank = data.bank + (idx * 50);
            }
          }
        });
      });
    }

    function loadPayrunHistory() {
      // Try to load payrun history from localStorage (from payruns.html)
      const data = {};
      try {
        const payruns = JSON.parse(localStorage.getItem('payruns_' + currentCompanyId) || '[]');
        payruns.forEach(run => {
          if (run.employees && run.period) {
            const mk = run.period; // e.g., "2025-03"
            run.employees.forEach(emp => {
              if (!data[emp.id]) data[emp.id] = {};
              data[emp.id][mk] = {
                income: { basic_salary: emp.grossPay || 0 },
                deductions: { paye: emp.paye || 0, uif: emp.uif || 0 },
                netPay: emp.netPay || 0
              };
            });
          }
        });
      } catch (e) { /* ignore */ }
      return data;
    }

    function updateStatus() {
      const badge = document.getElementById('statusBadge');
      badge.textContent = status;
      badge.className = 'status-badge status-' + status.toLowerCase();

      const readonly = status !== 'DRAFT';
      document.getElementById('saveBtn').disabled = readonly;
      document.getElementById('approveBtn').disabled = status !== 'DRAFT';
      document.getElementById('lockBtn').disabled = status !== 'APPROVED';
    }

    function renderTable() {
      const thead = document.getElementById('reconHead');
      const tbody = document.getElementById('reconBody');

      // Build header row
      let headerRow = '<tr><th class="name-col">Month</th>';
      config.incomeTypes.forEach(inc => { headerRow += `<th>${inc.label}</th>`; });
      headerRow += '<th class="total-row">Gross Income</th>';
      config.deductionTypes.forEach(ded => { headerRow += `<th>${ded.label}</th>`; });
      headerRow += '<th class="total-row">Total Deductions</th>';
      headerRow += '<th class="netto-row">Netto</th>';
      headerRow += '<th>Bank</th>';
      headerRow += '<th class="variance-row">Difference</th>';
      headerRow += '</tr>';

      thead.innerHTML = headerRow;
      tbody.innerHTML = '';

      const totalCols = 1 + config.incomeTypes.length + 1 + config.deductionTypes.length + 1 + 1 + 1 + 1;

      employees.forEach(emp => {
        // Employee header row
        const empRow = tbody.insertRow();
        empRow.className = 'employee-header';
        empRow.onclick = () => toggleEmployee(emp.id);
        let cell = empRow.insertCell();
        cell.className = 'name-col';
        cell.innerHTML = `<span class="expand-icon" id="icon-${emp.id}">‚ñ∂</span>${emp.firstName} ${emp.lastName}`;
        cell.colSpan = totalCols;

        // Month rows
        monthKeys.forEach((mk, idx) => {
          const monthRow = tbody.insertRow();
          monthRow.className = `employee-data emp-${emp.id}`;

          let monthCell = monthRow.insertCell();
          monthCell.className = 'name-col';
          monthCell.textContent = months[idx];

          // Income cells
          config.incomeTypes.forEach(inc => {
            let c = monthRow.insertCell();
            const val = reconData[emp.id][mk].income[inc.key] || 0;
            c.innerHTML = status === 'DRAFT'
              ? `<input type="number" step="0.01" value="${val||''}" onchange="updateIncome('${emp.id}','${mk}','${inc.key}',this.value)">`
              : (val ? val.toFixed(2) : '-');
          });

          // Gross
          let grossCell = monthRow.insertCell();
          grossCell.className = 'total-row';
          const gross = calculateGross(emp.id, mk);
          reconData[emp.id][mk].gross = gross;
          grossCell.textContent = gross ? gross.toFixed(2) : '-';

          // Deduction cells
          config.deductionTypes.forEach(ded => {
            let c = monthRow.insertCell();
            const val = reconData[emp.id][mk].deductions[ded.key] || 0;
            c.innerHTML = status === 'DRAFT'
              ? `<input type="number" step="0.01" value="${val||''}" onchange="updateDeduction('${emp.id}','${mk}','${ded.key}',this.value)">`
              : (val ? val.toFixed(2) : '-');
          });

          // Total Deductions
          let totalDedCell = monthRow.insertCell();
          totalDedCell.className = 'total-row';
          const totalDed = calculateTotalDed(emp.id, mk);
          reconData[emp.id][mk].totalDeductions = totalDed;
          totalDedCell.textContent = totalDed ? totalDed.toFixed(2) : '-';

          // Netto
          let nettoCell = monthRow.insertCell();
          nettoCell.className = 'netto-row';
          const netto = calculateNetto(emp.id, mk);
          reconData[emp.id][mk].netto = netto;
          nettoCell.textContent = netto ? netto.toFixed(2) : '-';

          // Bank
          let bankCell = monthRow.insertCell();
          const bank = reconData[emp.id][mk].bank || 0;
          bankCell.innerHTML = status === 'DRAFT'
            ? `<input type="number" step="0.01" value="${bank||''}" onchange="updateBank('${emp.id}','${mk}',this.value)">`
            : (bank ? bank.toFixed(2) : '-');

          // Difference
          let diffCell = monthRow.insertCell();
          diffCell.className = 'variance-row';
          const diff = calculateDiff(emp.id, mk);
          reconData[emp.id][mk].diff = diff;
          diffCell.textContent = diff ? diff.toFixed(2) : '-';
        });

        // TOTAL row
        const totalRow = tbody.insertRow();
        totalRow.className = `total-row employee-data emp-${emp.id}`;
        let totalLabel = totalRow.insertCell();
        totalLabel.className = 'name-col';
        totalLabel.textContent = 'TOTAL';

        config.incomeTypes.forEach(inc => {
          let c = totalRow.insertCell();
          let total = 0;
          monthKeys.forEach(mk => { total += parseFloat(reconData[emp.id][mk].income[inc.key]) || 0; });
          c.textContent = total ? total.toFixed(2) : '-';
        });

        let grossTotal = 0;
        monthKeys.forEach(mk => { grossTotal += calculateGross(emp.id, mk); });
        totalRow.insertCell().textContent = grossTotal ? grossTotal.toFixed(2) : '-';

        config.deductionTypes.forEach(ded => {
          let c = totalRow.insertCell();
          let total = 0;
          monthKeys.forEach(mk => { total += parseFloat(reconData[emp.id][mk].deductions[ded.key]) || 0; });
          c.textContent = total ? total.toFixed(2) : '-';
        });

        let totalDedSum = 0;
        monthKeys.forEach(mk => { totalDedSum += calculateTotalDed(emp.id, mk); });
        totalRow.insertCell().textContent = totalDedSum ? totalDedSum.toFixed(2) : '-';

        let nettoTotal = 0;
        monthKeys.forEach(mk => { nettoTotal += calculateNetto(emp.id, mk); });
        totalRow.insertCell().textContent = nettoTotal ? nettoTotal.toFixed(2) : '-';

        let bankTotal = 0;
        monthKeys.forEach(mk => { bankTotal += parseFloat(reconData[emp.id][mk].bank) || 0; });
        totalRow.insertCell().textContent = bankTotal ? bankTotal.toFixed(2) : '-';

        let diffTotal = 0;
        monthKeys.forEach(mk => { diffTotal += calculateDiff(emp.id, mk); });
        totalRow.insertCell().textContent = diffTotal ? diffTotal.toFixed(2) : '-';

        // Spacing row
        const emptyRow = tbody.insertRow();
        emptyRow.className = `employee-data emp-${emp.id}`;
        emptyRow.style.height = '10px';
        emptyRow.insertCell().colSpan = totalCols;
      });

      // Render summary sections
      renderCompanySummary(tbody, totalCols);
      renderEMP201Section(tbody, totalCols);
      renderDifferencesSection(tbody, totalCols);
    }

    function renderCompanySummary(tbody, totalCols) {
      const spacingRow = tbody.insertRow();
      spacingRow.style.height = '20px';
      spacingRow.insertCell().colSpan = totalCols;

      const headerRow = tbody.insertRow();
      let headerCell = headerRow.insertCell();
      headerCell.textContent = 'COMPANY SUMMARY - MONTHLY TOTALS';
      headerCell.colSpan = totalCols;
      headerCell.style.cssText = 'background: #667eea; color: white; font-weight: bold; text-align: center; font-size: 13px; padding: 10px; border-radius: 4px 4px 0 0;';

      const summaryHeaderRow = tbody.insertRow();
      ['Month', 'Gross Salary', 'PAYE', 'UIF', 'SDL', 'Total'].forEach(h => {
        let c = summaryHeaderRow.insertCell();
        c.textContent = h;
        c.style.cssText = 'background: #e8eaf6; font-weight: bold; text-align: ' + (h === 'Month' ? 'left' : 'right') + ';';
        if (h === 'Month') c.className = 'name-col';
      });

      let yearGross = 0, yearPaye = 0, yearUif = 0, yearSdl = 0;

      monthKeys.forEach((mk, idx) => {
        const monthRow = tbody.insertRow();
        let monthCell = monthRow.insertCell();
        monthCell.className = 'name-col';
        monthCell.textContent = months[idx];

        let totalGross = 0, totalPaye = 0, totalUif = 0;
        employees.forEach(emp => {
          totalGross += calculateGross(emp.id, mk);
          totalPaye += reconData[emp.id][mk].deductions['paye'] || 0;
          totalUif += reconData[emp.id][mk].deductions['uif'] || 0;
        });

        const uifTotal = totalUif * 2;
        const sdl = totalGross * 0.01;
        const total = totalPaye + uifTotal + sdl;

        yearGross += totalGross; yearPaye += totalPaye; yearUif += uifTotal; yearSdl += sdl;

        monthRow.insertCell().textContent = totalGross.toFixed(2);
        monthRow.insertCell().textContent = totalPaye.toFixed(2);
        monthRow.insertCell().textContent = uifTotal.toFixed(2);
        monthRow.insertCell().textContent = sdl.toFixed(2);
        let totalCell = monthRow.insertCell();
        totalCell.textContent = total.toFixed(2);
        totalCell.style.cssText = 'background: #e8f5e9; font-weight: bold;';
      });

      // Total row
      const summaryTotalRow = tbody.insertRow();
      summaryTotalRow.className = 'total-row';
      let totalLabel = summaryTotalRow.insertCell();
      totalLabel.className = 'name-col';
      totalLabel.textContent = 'TOTAL';
      summaryTotalRow.insertCell().textContent = yearGross.toFixed(2);
      summaryTotalRow.insertCell().textContent = yearPaye.toFixed(2);
      summaryTotalRow.insertCell().textContent = yearUif.toFixed(2);
      summaryTotalRow.insertCell().textContent = yearSdl.toFixed(2);
      summaryTotalRow.insertCell().textContent = (yearPaye + yearUif + yearSdl).toFixed(2);
    }

    function renderEMP201Section(tbody, totalCols) {
      const spacingRow = tbody.insertRow();
      spacingRow.style.height = '20px';
      spacingRow.insertCell().colSpan = totalCols;

      const headerRow = tbody.insertRow();
      let headerCell = headerRow.insertCell();
      headerCell.textContent = 'EMP201 SUBMITTED TO SARS';
      headerCell.colSpan = totalCols;
      headerCell.style.cssText = 'background: #43cea2; color: white; font-weight: bold; text-align: center; font-size: 13px; padding: 10px;';

      const emp201HeaderRow = tbody.insertRow();
      ['Month', 'PAYE', 'UIF', 'SDL', 'Total'].forEach(h => {
        let c = emp201HeaderRow.insertCell();
        c.textContent = h;
        c.style.cssText = 'background: #e0f2f1; font-weight: bold; text-align: ' + (h === 'Month' ? 'left' : 'right') + ';';
        if (h === 'Month') c.className = 'name-col';
      });

      let yearPaye = 0, yearUif = 0, yearSdl = 0;

      monthKeys.forEach((mk, idx) => {
        const monthRow = tbody.insertRow();
        let monthCell = monthRow.insertCell();
        monthCell.className = 'name-col';
        monthCell.textContent = months[idx];

        // PAYE input
        let payeCell = monthRow.insertCell();
        payeCell.innerHTML = status === 'DRAFT'
          ? `<input type="number" step="0.01" value="${emp201Data[mk].paye||''}" onchange="updateEMP201('${mk}','paye',this.value)">`
          : (emp201Data[mk].paye ? emp201Data[mk].paye.toFixed(2) : '-');

        // UIF input
        let uifCell = monthRow.insertCell();
        uifCell.innerHTML = status === 'DRAFT'
          ? `<input type="number" step="0.01" value="${emp201Data[mk].uif||''}" onchange="updateEMP201('${mk}','uif',this.value)">`
          : (emp201Data[mk].uif ? emp201Data[mk].uif.toFixed(2) : '-');

        // SDL input
        let sdlCell = monthRow.insertCell();
        sdlCell.innerHTML = status === 'DRAFT'
          ? `<input type="number" step="0.01" value="${emp201Data[mk].sdl||''}" onchange="updateEMP201('${mk}','sdl',this.value)">`
          : (emp201Data[mk].sdl ? emp201Data[mk].sdl.toFixed(2) : '-');

        const total = (parseFloat(emp201Data[mk].paye) || 0) + (parseFloat(emp201Data[mk].uif) || 0) + (parseFloat(emp201Data[mk].sdl) || 0);
        let totalCell = monthRow.insertCell();
        totalCell.textContent = total.toFixed(2);
        totalCell.style.cssText = 'background: #e8f5e9; font-weight: bold;';

        yearPaye += parseFloat(emp201Data[mk].paye) || 0;
        yearUif += parseFloat(emp201Data[mk].uif) || 0;
        yearSdl += parseFloat(emp201Data[mk].sdl) || 0;
      });

      const emp201TotalRow = tbody.insertRow();
      emp201TotalRow.className = 'total-row';
      let totalLabel = emp201TotalRow.insertCell();
      totalLabel.className = 'name-col';
      totalLabel.textContent = 'TOTAL';
      emp201TotalRow.insertCell().textContent = yearPaye.toFixed(2);
      emp201TotalRow.insertCell().textContent = yearUif.toFixed(2);
      emp201TotalRow.insertCell().textContent = yearSdl.toFixed(2);
      emp201TotalRow.insertCell().textContent = (yearPaye + yearUif + yearSdl).toFixed(2);
    }

    function renderDifferencesSection(tbody, totalCols) {
      const spacingRow = tbody.insertRow();
      spacingRow.style.height = '20px';
      spacingRow.insertCell().colSpan = totalCols;

      const headerRow = tbody.insertRow();
      let headerCell = headerRow.insertCell();
      headerCell.textContent = 'RECONCILIATION DIFFERENCES (Calculated - Submitted)';
      headerCell.colSpan = totalCols;
      headerCell.style.cssText = 'background: #f5576c; color: white; font-weight: bold; text-align: center; font-size: 13px; padding: 10px;';

      const diffHeaderRow = tbody.insertRow();
      ['Month', 'PAYE Diff', 'UIF Diff', 'SDL Diff', 'Total Diff'].forEach(h => {
        let c = diffHeaderRow.insertCell();
        c.textContent = h;
        c.style.cssText = 'background: #fce4ec; font-weight: bold; text-align: ' + (h === 'Month' ? 'left' : 'right') + ';';
        if (h === 'Month') c.className = 'name-col';
      });

      let yearPayeDiff = 0, yearUifDiff = 0, yearSdlDiff = 0;

      monthKeys.forEach((mk, idx) => {
        const monthRow = tbody.insertRow();
        let monthCell = monthRow.insertCell();
        monthCell.className = 'name-col';
        monthCell.textContent = months[idx];

        let calcGross = 0, calcPaye = 0, calcUif = 0;
        employees.forEach(emp => {
          calcGross += calculateGross(emp.id, mk);
          calcPaye += reconData[emp.id][mk].deductions['paye'] || 0;
          calcUif += reconData[emp.id][mk].deductions['uif'] || 0;
        });
        const calcUifTotal = calcUif * 2;
        const calcSdl = calcGross * 0.01;

        const submittedPaye = parseFloat(emp201Data[mk].paye) || 0;
        const submittedUif = parseFloat(emp201Data[mk].uif) || 0;
        const submittedSdl = parseFloat(emp201Data[mk].sdl) || 0;

        const payeDiff = calcPaye - submittedPaye;
        const uifDiff = calcUifTotal - submittedUif;
        const sdlDiff = calcSdl - submittedSdl;
        const totalDiff = payeDiff + uifDiff + sdlDiff;

        yearPayeDiff += payeDiff;
        yearUifDiff += uifDiff;
        yearSdlDiff += sdlDiff;

        [payeDiff, uifDiff, sdlDiff, totalDiff].forEach(val => {
          let c = monthRow.insertCell();
          c.textContent = val.toFixed(2);
          c.style.background = val !== 0 ? '#fce4ec' : '#e8f5e9';
          c.style.color = val < 0 ? '#dc3545' : (val > 0 ? '#856404' : '#155724');
          c.style.fontWeight = val !== 0 ? 'bold' : 'normal';
        });
      });

      const diffTotalRow = tbody.insertRow();
      diffTotalRow.className = 'total-row';
      let totalLabel = diffTotalRow.insertCell();
      totalLabel.className = 'name-col';
      totalLabel.textContent = 'TOTAL';

      const yearTotalDiff = yearPayeDiff + yearUifDiff + yearSdlDiff;
      [yearPayeDiff, yearUifDiff, yearSdlDiff, yearTotalDiff].forEach(val => {
        let c = diffTotalRow.insertCell();
        c.textContent = val.toFixed(2);
        c.style.color = val < 0 ? '#dc3545' : (val > 0 ? '#856404' : '#155724');
        c.style.fontWeight = 'bold';
      });
    }

    // === Data Update Functions ===
    window.updateEMP201 = function(monthKey, field, value) {
      emp201Data[monthKey][field] = parseFloat(value) || 0;
      renderTable();
    };

    window.updateIncome = function(empId, monthKey, incKey, value) {
      reconData[empId][monthKey].income[incKey] = parseFloat(value) || 0;
      renderTable();
    };

    window.updateDeduction = function(empId, monthKey, dedKey, value) {
      reconData[empId][monthKey].deductions[dedKey] = parseFloat(value) || 0;
      renderTable();
    };

    window.updateBank = function(empId, monthKey, value) {
      reconData[empId][monthKey].bank = parseFloat(value) || 0;
      renderTable();
    };

    // === Calculation Functions ===
    function calculateGross(empId, monthKey) {
      const data = reconData[empId][monthKey];
      return Object.values(data.income).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
    }

    function calculateTotalDed(empId, monthKey) {
      const data = reconData[empId][monthKey];
      return Object.values(data.deductions).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
    }

    function calculateNetto(empId, monthKey) {
      return calculateGross(empId, monthKey) - calculateTotalDed(empId, monthKey);
    }

    function calculateDiff(empId, monthKey) {
      return calculateNetto(empId, monthKey) - (parseFloat(reconData[empId][monthKey].bank) || 0);
    }

    // === Workflow Functions ===
    function saveDraft() {
      if (status !== 'DRAFT') {
        alert('Cannot save - reconciliation is ' + status);
        return;
      }

      const saveData = {
        reconData: reconData,
        emp201Data: emp201Data,
        status: status,
        savedAt: new Date().toISOString(),
        periodId: currentPeriodId
      };

      localStorage.setItem('paye_recon_data_' + currentCompanyId, JSON.stringify(saveData));
      alert('‚úÖ Draft saved successfully!');
    }

    function approveRecon() {
      if (!confirm('Approve this reconciliation? It will become read-only.')) return;
      status = 'APPROVED';
      const saveData = {
        reconData: reconData,
        emp201Data: emp201Data,
        status: status,
        approvedAt: new Date().toISOString(),
        periodId: currentPeriodId
      };
      localStorage.setItem('paye_recon_data_' + currentCompanyId, JSON.stringify(saveData));
      updateStatus();
      renderTable();
      alert('‚úÖ Reconciliation approved!');
    }

    function lockRecon() {
      if (!confirm('Lock this reconciliation? This is FINAL and cannot be undone.')) return;
      status = 'LOCKED';
      const saveData = {
        reconData: reconData,
        emp201Data: emp201Data,
        status: status,
        lockedAt: new Date().toISOString(),
        periodId: currentPeriodId
      };
      localStorage.setItem('paye_recon_data_' + currentCompanyId, JSON.stringify(saveData));
      updateStatus();
      renderTable();
      alert('üîí Reconciliation locked!');
    }

    function loadPeriod() {
      init();
    }

    window.toggleEmployee = function(empId) {
      const rows = document.querySelectorAll(`.emp-${empId}`);
      const icon = document.getElementById(`icon-${empId}`);
      const isExpanded = rows[0]?.classList.contains('expanded');
      rows.forEach(row => {
        if (isExpanded) row.classList.remove('expanded');
        else row.classList.add('expanded');
      });
      if (icon) icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
    };

    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        AUTH.logout();
      }
    }

    // Initialize
    init();
  </script>
  <script src="js/mobile-utils.js"></script>
</body>
</html>
